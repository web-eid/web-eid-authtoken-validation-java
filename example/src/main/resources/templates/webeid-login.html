<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Signing you inâ€¦</title>
</head>
<body>
<div id="error-message" class="alert alert-danger" style="display: none;" role="alert">
    <div class="message"></div>
    <pre class="details"></pre>
</div>

<script type="module" th:inline="javascript">
    import { showErrorMessage } from "/js/errors.js";

    // Using an async IIFE for mobile WebView compatibility:
    // top-level await is not supported in some mobile browsers/WebViews.
    (async function () {
        const frag = location.hash ? location.hash.substring(1) : "";
        if (!frag) {
            showErrorMessage({ code: "UNKNOWN_ERROR", message: "Missing authentication payload" });
            return;
        }

        let payload;
        try {
            payload = JSON.parse(atob(frag));
        } catch (e) {
            console.error("Failed to parse payload", e);
            showErrorMessage({ code: "UNKNOWN_ERROR", message: "Failed to parse authentication payload" });
            return;
        }

        if (payload.error) {
            showErrorMessage({
                code: payload.code ?? "UNKNOWN_ERROR",
                message: payload.message ?? "Authentication failed"
            });
            return;
        }

        const authToken = payload["auth-token"];

        try {
            const response = await fetch(/*[[${loginProcessingPath}]]*/, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-TOKEN": /*[[${csrfToken}]]*/
                },
                body: JSON.stringify(authToken),
                credentials: "include"
            });

            if (!response.ok) {
                throw new Error("HTTP " + response.status);
            }

            window.location.replace("/welcome");
        } catch (error) {
            console.error(error);
            showErrorMessage(error);
        }
    })();
</script>
</body>
</html>
