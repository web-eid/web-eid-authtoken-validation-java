<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta http-equiv="Cache-Control" content="no-store" />
        <meta id="csrftoken" name="csrftoken" th:content="${_csrf.token}" />
        <meta id="csrfheadername" name="csrfheadername" th:content="${_csrf.headerName}" />
        <title>Completing signing…</title>
        <link rel="stylesheet" href="/css/bootstrap.min.css" />
        <link rel="stylesheet" href="/css/main.css" />
    </head>

    <body class="loading-page">
        <div id="spinner-message">
            <h2>Completing signing…</h2>
            <div class="spinner"></div>
        </div>
        <div id="error-message" class="alert alert-danger" style="display: none" role="alert">
            <div class="message"></div>
            <pre class="details"></pre>
        </div>

        <p class="text-center p-4" style="display: none" id="error-actions">
            <button id="back-button" class="btn btn-primary">Back</button>
        </p>

        <script type="module">
            import { showErrorMessage, checkHttpError } from "/js/errors.js";
            import { parsePayload } from "/js/payload.js";

            // Using an async IIFE for mobile WebView compatibility:
            // top-level await is not supported in some mobile browsers/WebViews.
            (async () => {
                const payload = parsePayload("Signing");
                const path = window.location.pathname;
                const allowedEndpoints = ["/sign/mobile/certificate", "/sign/mobile/signature"];
                if (!allowedEndpoints.includes(path)) {
                    const error = new Error("Unexpected callback path: " + path);
                    error.code = "INVALID_CALLBACK_PATH";
                    throw error;
                }

                const endpoint = path;
                const csrfHeaderName = document.querySelector("#csrfheadername").content;
                const csrfToken = document.querySelector("#csrftoken").content;
                const response = await fetch(endpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        [csrfHeaderName]: csrfToken
                    },
                    credentials: "include",
                    body: JSON.stringify(payload)
                });
                await checkHttpError(response);

                const result = await response.json();
                if (endpoint.endsWith("/certificate")) {
                    const { request_uri } = result;
                    window.location.replace(request_uri);
                    return;
                }

                window.location.replace("/welcome?signed=" + encodeURIComponent(result.name));
            })().catch((error) => {
                console.error(error);
                showErrorMessage(error, "Signing failed");
                const spinner = document.querySelector("#spinner-message");
                spinner.style.display = "none";
                const actions = document.getElementById("error-actions");
                const goBackButton = document.getElementById("back-button");
                actions.style.display = "block";
                goBackButton.addEventListener("click", () => {
                    window.location.replace("/welcome?error=webeid-callback");
                });
            });
        </script>
    </body>
</html>
